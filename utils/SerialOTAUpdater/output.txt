============================= test session starts ==============================
platform darwin -- Python 3.11.6, pytest-7.3.1, pluggy-1.0.0 -- /opt/homebrew/opt/python@3.11/bin/python3.11
cachedir: .pytest_cache
rootdir: /Users/nb182/Projects/personal/ns-serial-esp32-ota/utils/SerialOTAUpdater
plugins: snapshot-0.9.0, pyfakefs-5.2.2, requests-mock-1.10.0, mock-1.11.1
collecting ... collected 1 item

test_update.py::test_main_happy_path_with_snapshot FAILED                [100%]

=================================== FAILURES ===================================
______________________ test_main_happy_path_with_snapshot ______________________

snapshot = <pytest_snapshot.plugin.Snapshot object at 0x10666cc50>
mock_exists = <MagicMock name='exists' id='4402369808'>
mock_modbus_client = <MagicMock name='ModbusClient' id='4402378256'>
mock_serial = <MagicMock name='Serial' id='4402400528'>

    def test_main_happy_path_with_snapshot(snapshot, mock_exists, mock_modbus_client, mock_serial):
        mock_modbus_instance = MagicMock()
        mock_modbus_client.return_value = mock_modbus_instance
        mock_modbus_instance.connect.return_value = True
        mock_modbus_instance.write_register.return_value = None
        mock_modbus_instance.close.return_value = None
    
        written_data = []
    
        def record_write(data):
            written_data.append(data)
    
        mock_serial_instance = MagicMock()
        mock_serial.return_value = mock_serial_instance
        mock_serial_instance.write.side_effect = record_write
        mock_serial_instance.read.return_value = b''
    
        mock_1024_byte_firmware_file = b'0' * 1024
        mock_file = mock_open(read_data=mock_1024_byte_firmware_file)
    
        captured_output = StringIO()
        sys.stdout = captured_output
    
        test_args = ["script_name", "-i", "COM1", "-f", "firmware.bin"]
        with patch.object(sys, 'argv', test_args):
            with patch('builtins.open', mock_file):
                update.main(sys.argv[1:])
    
        sys.stdout = sys.__stdout__
    
        assert "Firmware transfer completed" in captured_output.getvalue()
    
        # Convert bytearrays to a hex string representation
        serial_output_str = '\n'.join([bytes(data).hex() for data in written_data])
        # Snapshot testing for serial output
>       snapshot.assert_match(serial_output_str, 'serial_output_snapshot.txt')
E       AssertionError: value does not match the expected value in snapshot snapshots/test_update/test_main_happy_path_with_snapshot/serial_output_snapshot.txt
E         (run pytest with --snapshot-update to update snapshots)
E       assert 'ffffffffffff000002d9\nffffffffffff000002d9\nffffffffffff000002d9\nc0fffeaa5590000002eb\n00002100023030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030\n01002100023030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030\n0200000000' == 'ffffffffffff000002d9\nffffffffffff000002d9\nffffffffffff000002d9\nc0fffeaa5590000002eb\n00002100023030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030\n01002100023030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030\n0200000000\n0300000000'
E           ffffffffffff000002d9
E           ffffffffffff000002d9
E           ffffffffffff000002d9
E           c0fffeaa5590000002eb
E           00002100023030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030
E           01002100023030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030
E         - 0200000000
E         ?           -
E         + 0200000000
E         - 0300000000

test_update.py:58: AssertionError
=========================== short test summary info ============================
FAILED test_update.py::test_main_happy_path_with_snapshot - AssertionError: v...
============================== 1 failed in 34.09s ==============================
